#!/bin/sh
# deploy script

NODE_ENV=test
domain=example.com
tmp_dir=~/tmp/$domain

mkdir -p "$tmp_dir"
git --work-tree="$tmp_dir" checkout -f

# change to tmp directory
cd "$tmp_dir"

# install packages
npm install

# deploy app
NODE_ENV=$NODE_ENV grunt deploy

# restart app
# /etc/init.d/node-app restart
forever restartall

# verify server is up
curl -I# http://$domain
curl -I# http://$domain/api

# cleanup
rm -rf "$tmp_dir"
